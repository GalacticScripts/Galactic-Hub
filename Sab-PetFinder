
--== USER CONFIG ===============================================================
getgenv().PersonalWebhook = "https://discord.com/api/webhooks/1436947291196882944/fHYylID8lkYCQ7A8106dRWj4clAwvei-aLIQsveHMxznrWA2gVsYkb7tzY_dpZW8fwVE"
getgenv().SharedWebhook = "https://discord.com/api/webhooks/1436947384092590116/0fWmzPrp-eHqjgfjQj5-gnsXuzv5kC00hv5gGb8uDTydbCvvuWWfE7NJl43xBl-fjITG"
getgenv().YourName        = getgenv().YourName or "YourNameHere"

-- Targets (exact name match, case-insensitive)
getgenv().TargetPetNames = getgenv().TargetPetNames or {
    "Chillin Chili","Strawberry Elephant","Los Tacoritas","La Extinct Grande","Los 67",
    "Money Money Puggy","Garama and Madundung","La Grande Combinasion","Nuclearo Dinossauro",
    "Spaghetti Tualetti","Dragon Cannelloni","Tralaledon","Ketupat Kepat","La Supreme Combinasion",
    "Ketchuru and Musturu","Los Bros","67","Los Noo My Hotspotsitos","Celularcini Viciosini",
    "Los Combinasionas","Burguro And Fryuro","Chicleteira Bicicleteira","Chicleteirina Bicicleteirina",
    "Eviledon","La Spooky Grande","Las Sis","Los Chicleteiras","Los Hotspotsitos","Los Mobilis",
    "Mariachi Corazoni","Secret Lucky Block","Tacorita Bicicleta","Tang Tang Keletang","Tictac Sahur",
    "To to to Sahur","Esok Sekolah","Spooky and Pumpy","Noo My Hotspot","Chipso and Queso",
    "Mieteteira Bicicleteira","Headless Horseman","La Taco Combinasion","La Casa Boo","Meowl",
    "Los Primos","Los Spooky Combanasionias","Noo my examine","Quesadilla Vampiro","Burrito Bandito",
    "La Secret Combinasion","Horegini Boom","La Sahur Combinasion","Pot Pumpkin","Quesadilla Crocodila",
    "Rang Ring Bus","Noo my Candy","Vulturino Skeletono","Los Tortus","Blackhole Goat",
    "Los Tralaleritos","Guerriro Digitale","La Cucaracha","Las Tralaleritas","Zombie Tralala"
}

-- Server filters (will be coerced to numbers safely)
getgenv().ScriptURL  = "https://raw.githubusercontent.com/GalacticScripts/Galactic-Hub/refs/heads/main/Sab-PetFinder"
getgenv().MinPlayers = 5
getgenv().MaxPlayers = 40
getgenv().ShareDiscoveries   = true
getgenv().NotifyOnGroupFinds = true

-- ===== Services =====
local Players         = game:GetService("Players")
local HttpService     = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local StarterGui      = game:GetService("StarterGui")

-- ===== Locals / Safe defaults =====
local LocalPlayer repeat LocalPlayer = Players.LocalPlayer task.wait() until LocalPlayer

local function toNum(x, d)  return tonumber(x) or d end
local personalWebhook   = getgenv().PersonalWebhook or ""
local sharedWebhook     = getgenv().SharedWebhook   or ""
local yourName          = getgenv().YourName or LocalPlayer.Name
local targetPets        = getgenv().TargetPetNames or {}
local scriptURL         = getgenv().ScriptURL or ""
local minPlayers        = toNum(getgenv().MinPlayers, 5)
local maxPlayers        = toNum(getgenv().MaxPlayers, 40)
local shareDiscoveries  = not not getgenv().ShareDiscoveries
local notifyOnGroupFinds= not not getgenv().NotifyOnGroupFinds

-- hard constants (avoid nil-comparisons)
local MAX_FETCH_FAILS   = 4
local MAX_PAGE_TRIES    = 3

-- global counters
getgenv().TotalScans  = toNum(getgenv().TotalScans, 0)
getgenv().TotalFinds  = toNum(getgenv().TotalFinds, 0)
getgenv().GroupFinds  = toNum(getgenv().GroupFinds, 0)
getgenv().StartTime   = getgenv().StartTime or os.time()

-- state
local visitedJobIds = {[game.JobId] = true}
local hops, maxHopsBeforeReset = 0, 50
local teleportFails, maxTeleportRetries = 0, 3
local detectedPets = {}
local webhookSent, stopHopping = false, false

-- ===== Re-queue helper =====
local function queueScript()
  local code = ([[
    repeat task.wait() until game:IsLoaded()
    task.wait(3)
    local ok,err = pcall(function() loadstring(game:HttpGet("%s"))() end)
    if not ok then warn("Failed to load script:", err) end
  ]]):format(scriptURL)
  if queue_on_teleport then queue_on_teleport(code) end
  if syn and syn.queue_on_teleport then syn.queue_on_teleport(code) end
  if fluxus and fluxus.queue_on_teleport then fluxus.queue_on_teleport(code) end
end

-- ===== UI Prompt when a target is found =====
local function promptStayOrHop()
  -- quick Core notification as a fallback
  pcall(function()
    StarterGui:SetCore("SendNotification", {
      Title = "Target Found",
      Text  = "Stay here or keep hopping?",
      Duration = 8,
      Button1 = "Stay here",
      Button2 = "Keep hopping"
    })
  end)

  -- lightweight ScreenGui with buttons
  local gui = Instance.new("ScreenGui")
  gui.Name = "FinderPrompt"
  gui.ResetOnSpawn = false
  gui.Parent = game:GetService("CoreGui")

  local frame = Instance.new("Frame")
  frame.Size = UDim2.fromOffset(360, 120)
  frame.Position = UDim2.new(0.5, -180, 0.15, 0)
  frame.BackgroundColor3 = Color3.fromRGB(20,20,20)
  frame.BackgroundTransparency = 0.1
  frame.Parent = gui

  local uiCorner = Instance.new("UICorner", frame)
  uiCorner.CornerRadius = UDim.new(0,12)

  local label = Instance.new("TextLabel")
  label.Size = UDim2.new(1, -20, 0, 48)
  label.Position = UDim2.fromOffset(10, 8)
  label.BackgroundTransparency = 1
  label.Font = Enum.Font.GothamBold
  label.TextScaled = true
  label.Text = "ğŸ¯ Target detected â€” what next?"
  label.TextColor3 = Color3.new(1,1,1)
  label.Parent = frame

  local stay = Instance.new("TextButton")
  stay.Text = "Stay here"
  stay.Size = UDim2.new(0.48, -15, 0, 44)
  stay.Position = UDim2.fromOffset(10, 68)
  stay.BackgroundColor3 = Color3.fromRGB(50,170,90)
  Instance.new("UICorner", stay).CornerRadius = UDim.new(0,8)
  stay.Parent = frame

  local hop = Instance.new("TextButton")
  hop.Text = "Keep hopping"
  hop.Size = UDim2.new(0.48, -15, 0, 44)
  hop.Position = UDim2.new(1, -10, 0, 68)
  hop.AnchorPoint = Vector2.new(1,0)
  hop.BackgroundColor3 = Color3.fromRGB(200,70,70)
  Instance.new("UICorner", hop).CornerRadius = UDim.new(0,8)
  hop.Parent = frame

  stay.MouseButton1Click:Connect(function()
    stopHopping = true
    gui:Destroy()
  end)
  hop.MouseButton1Click:Connect(function()
    stopHopping = false
    gui:Destroy()
    task.defer(function() serverHop() end)
  end)
end

-- ===== Teleport failure handling =====
TeleportService.TeleportInitFailed:Connect(function(_, result)
  teleportFails += 1
  if result == Enum.TeleportResult.GameFull then
    warn("âš ï¸ Game full. Retrying teleportâ€¦")
  elseif result == Enum.TeleportResult.Unauthorized then
    warn("âŒ Unauthorized/private server. Blacklisting & retryâ€¦")
    visitedJobIds[game.JobId] = true
  else
    warn("âŒ Teleport error:", result)
  end
  if teleportFails >= maxTeleportRetries then
    teleportFails = 0
    queueScript()
    TeleportService:Teleport(game.PlaceId)
  else
    task.wait(1)
    serverHop()
  end
end)

-- ===== ESP =====
local function addESP(targetModel)
  if targetModel:FindFirstChild("PetESP", true) or targetModel:FindFirstChild("PetHighlight", true) then return end
  local part = targetModel.PrimaryPart or targetModel:FindFirstChildWhichIsA("BasePart", true)
  if not part then return end

  local bb = Instance.new("BillboardGui")
  bb.Name, bb.Adornee, bb.AlwaysOnTop = "PetESP", part, true
  bb.Size         = UDim2.new(0, 220, 0, 60)
  bb.StudsOffset  = Vector3.new(0, 6, 0)
  bb.MaxDistance  = 600
  bb.Parent       = part

  local label = Instance.new("TextLabel")
  label.Size = UDim2.fromScale(1,1)
  label.BackgroundTransparency = 0.15
  label.BackgroundColor3 = Color3.fromRGB(25,25,25)
  label.Text = "ğŸ¯ TARGET: ".. targetModel.Name
  label.TextColor3 = Color3.new(1,1,1)
  label.TextStrokeTransparency = 0.1
  label.TextScaled = true
  label.Font = Enum.Font.GothamBlack
  label.Parent = bb
  local stroke = Instance.new("UIStroke", label)
  stroke.Thickness = 2.5
  stroke.Color = Color3.fromRGB(255,0,0)

  local hl = Instance.new("Highlight")
  hl.Name, hl.Adornee = "PetHighlight", targetModel
  hl.FillColor, hl.FillTransparency = Color3.fromRGB(255,60,60), 0.75
  hl.OutlineColor, hl.OutlineTransparency = Color3.fromRGB(255,0,0), 0
  hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
  hl.Parent = targetModel
end

-- ===== Webhook plumbing =====
local function sendToWebhook(url, json)
  local req = http_request or request or (syn and syn.request)
  if not req then return false, "No HTTP in executor" end
  return pcall(function()
    req({ Url = url, Method = "POST", Headers = {["Content-Type"]="application/json"}, Body = json })
  end)
end

local function sendWebhook(foundPets)
  getgenv().TotalFinds += 1

  local counts = {}
  for _,p in ipairs(foundPets) do counts[p] = (counts[p] or 0)+1 end
  local list = {}
  for name,c in pairs(counts) do table.insert(list, c>1 and (name.." x"..c) or name) end

  local link  = "[Join Server](https://fern.wtf/joiner?placeId="..game.PlaceId.."&gameInstanceId="..game.JobId..")"
  local run   = os.time() - getgenv().StartTime
  local hrs   = math.floor(run/3600)
  local mins  = math.floor((run%3600)/60)
  local tstr  = (hrs>0) and (hrs.."h "..mins.."m") or (mins.."m")

  local function packEmbed(descTitle, descBody)
    return HttpService:JSONEncode({
      content = "@everyone ğŸš¨ SECRET PET DETECTED!",
      embeds = {{
        title = descTitle,
        description = descBody,
        fields = {
          {name="ğŸ“ Location", value = ("`TeleportService:TeleportToPlaceInstance(%d, '%s')`"):format(game.PlaceId, game.JobId)},
          {name="ğŸ‘¥ Players",  value = tostring(#Players:GetPlayers()), inline=true},
          {name="ğŸ¾ Pets Found", value = table.concat(list, "\n")},
          {name="ğŸ”— Quick Join", value = link},
          {name="ğŸ“Š Stats", value = ("Scans %d | Finds %d | Runtime %s"):format(getgenv().TotalScans, getgenv().TotalFinds, tstr)},
          {name="â° Time", value = os.date("%m/%d/%y, %I:%M %p")}
        },
        color = 0xFF3366,
        footer = { text = "PlaceId: "..game.PlaceId.." â€¢ Found by "..yourName }
      }}
    })
  end

  if personalWebhook ~= "" then
    local ok = sendToWebhook(personalWebhook, packEmbed("ğŸ¯ "..#foundPets.." Secret Pet(s) Found!", "**YOU found secret pets in this server!**"))
    if ok then print("âœ… Personal webhook sent!") end
  end
  if shareDiscoveries and sharedWebhook ~= "" then
    local ok = sendToWebhook(sharedWebhook, packEmbed("ğŸ§  "..#foundPets.." Secret Pet(s) Found!", "**"..yourName.."** discovered secret pets!"))
    if ok then print("âœ… Shared discovery sent to group!") end
  end

  -- show prompt so the player decides to stay / hop
  task.defer(promptStayOrHop)
end

-- ===== Target match / scanning =====
local function matchesTarget(name)
  for _,t in ipairs(targetPets) do
    if string.lower(name) == string.lower(t) then return true end
  end
  return false
end

local function checkForPets()
  local found = {}
  local plots = workspace:FindFirstChild("Plots")
  if not plots then return found end
  for _,plot in ipairs(plots:GetChildren()) do
    if plot:IsA("Model") then
      for _,obj in ipairs(plot:GetChildren()) do
        if obj:IsA("Model") and matchesTarget(obj.Name) and not obj:FindFirstChild("PetESP") then
          addESP(obj)
          table.insert(found, obj.Name)
          stopHopping = true
        end
      end
    end
  end
  return found
end

-- ===== Server hop =====
function serverHop()
  if stopHopping then return end

  local PlaceId, JobId = game.PlaceId, game.JobId
  local fetchFails, backoff, tries, cursor = 0, 3.0, 0, nil

  hops += 1
  if hops >= maxHopsBeforeReset then
    visitedJobIds = {[JobId]=true}
    hops = 0
    print("â™»ï¸ Resetting visited JobIds.")
  end

  local function forceRandomHop()
    warn("âš ï¸ Forcing random hop (fallback)â€¦")
    queueScript()
    TeleportService:Teleport(PlaceId)
  end

  while tries < MAX_PAGE_TRIES do
    local url = ("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100"):format(PlaceId)
    if cursor then url ..= "&cursor="..cursor end

    local ok, decoded = pcall(function()
      local raw = HttpService:GetAsync(url, true)
      return HttpService:JSONDecode(raw)
    end)

    if not ok or not decoded or not decoded.data then
      fetchFails += 1
      warn(("âš ï¸ Failed to fetch server list. Retrying in %.0f seconds..."):format(backoff))
      task.wait(backoff)
      backoff = math.min(backoff + 3, 15)
      if fetchFails >= MAX_FETCH_FAILS then
        return forceRandomHop()
      end
    else
      local servers = {}
      for _,s in ipairs(decoded.data) do
        local playing = toNum(s.playing, 0)
        local maxp    = toNum(s.maxPlayers, 1)
        if playing >= minPlayers and playing <= maxPlayers and playing < maxp and s.id ~= JobId and not visitedJobIds[s.id] then
          table.insert(servers, {id=s.id, players=playing})
        end
      end
      if #servers > 0 then
        table.sort(servers, function(a,b) return a.players > b.players end)
        local pick = servers[1].id
        visitedJobIds[pick] = true
        print(("âœ… Hopping to server with %d players: %s"):format(servers[1].players, pick))
        teleportFails = 0
        queueScript()
        TeleportService:TeleportToPlaceInstance(PlaceId, pick)
        return
      end
      cursor = decoded.nextPageCursor
      if not cursor then tries += 1; task.wait(1.5) else task.wait(0.4) end
    end
  end

  forceRandomHop()
end

-- live detection
workspace.DescendantAdded:Connect(function(obj)
  task.wait(0.25)
  local plots = workspace:FindFirstChild("Plots")
  if plots and obj:IsA("Model") and obj.Parent and obj.Parent:IsDescendantOf(plots) and matchesTarget(obj.Name) and not obj:FindFirstChild("PetESP") then
    if not detectedPets[obj] then
      detectedPets[obj] = true
      addESP(obj)
      print("ğŸ¯ New pet appeared:", obj.Name)
      stopHopping = true
      if not webhookSent then
        webhookSent = true
        sendWebhook({obj.Name})
      end
    end
  end
end)

-- ===== Banner & first sweep =====
print(("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ” Pet Finder - Shared Discovery Edition\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ Username: %s\nğŸ“Š Total scans: %d\nğŸ¯ Your finds: %d\nğŸ¤ Group sharing: %s\nâ±ï¸ Session runtime: %d minutes\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
  :format(yourName, getgenv().TotalScans, getgenv().TotalFinds, (shareDiscoveries and "ENABLED" or "DISABLED"), math.floor((os.time()-getgenv().StartTime)/60)))

task.wait(6)
getgenv().TotalScans += 1

local first = checkForPets()
if #first > 0 then
  for _,n in ipairs(first) do detectedPets[n] = true end
  if not webhookSent then
    print("ğŸ¯ Found pet(s):", table.concat(first, ", "))
    webhookSent = true
    sendWebhook(first)
  end
else
  print("ğŸ” No target pets found. Hopping to next serverâ€¦")
  task.delay(1.5, serverHop)
end
    print("ğŸ” No target pets found. Hopping to next server...")
    task.delay(1.5, serverHop)
end
