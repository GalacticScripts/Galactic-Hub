--========================================================
--  Pet Finder ‚Äì Shared Discovery Edition (Full Script)
--  Œî-executor friendly. Works with http_request/request/syn.request.
--  Fill in your webhooks below.
--========================================================

--== USER CONFIG ===============================================================
getgenv().PersonalWebhook = getgenv().PersonalWebhook or "PUT_YOUR_PERSONAL_WEBHOOK_HERE"
getgenv().SharedWebhook   = getgenv().SharedWebhook   or "PUT_YOUR_SHARED_WEBHOOK_HERE"
getgenv().YourName        = getgenv().YourName or "YourNameHere"

-- Targets (exact name match, case-insensitive)
getgenv().TargetPetNames = getgenv().TargetPetNames or {
    "Chillin Chili","Strawberry Elephant","Los Tacoritas","La Extinct Grande","Los 67",
    "Money Money Puggy","Garama and Madundung","La Grande Combinasion","Nuclearo Dinossauro",
    "Spaghetti Tualetti","Dragon Cannelloni","Tralaledon","Ketupat Kepat","La Supreme Combinasion",
    "Ketchuru and Musturu","Los Bros","67","Los Noo My Hotspotsitos","Celularcini Viciosini",
    "Los Combinasionas","Burguro And Fryuro","Chicleteira Bicicleteira","Chicleteirina Bicicleteirina",
    "Eviledon","La Spooky Grande","Las Sis","Los Chicleteiras","Los Hotspotsitos","Los Mobilis",
    "Mariachi Corazoni","Secret Lucky Block","Tacorita Bicicleta","Tang Tang Keletang","Tictac Sahur",
    "To to to Sahur","Esok Sekolah","Spooky and Pumpy","Noo My Hotspot","Chipso and Queso",
    "Mieteteira Bicicleteira","Headless Horseman","La Taco Combinasion","La Casa Boo","Meowl",
    "Los Primos","Los Spooky Combanasionias","Noo my examine","Quesadilla Vampiro","Burrito Bandito",
    "La Secret Combinasion","Horegini Boom","La Sahur Combinasion","Pot Pumpkin","Quesadilla Crocodila",
    "Rang Ring Bus","Noo my Candy","Vulturino Skeletono","Los Tortus","Blackhole Goat",
    "Los Tralaleritos","Guerriro Digitale","La Cucaracha","Las Tralaleritas","Zombie Tralala"
}

-- Server filters (will be coerced to numbers safely)
getgenv().MinPlayers       = getgenv().MinPlayers or 5
getgenv().MaxPlayers       = getgenv().MaxPlayers or 40
getgenv().ShareDiscoveries = (getgenv().ShareDiscoveries ~= false) -- default true
getgenv().NotifyOnGroupFinds = (getgenv().NotifyOnGroupFinds ~= false)

--== SERVICES / LOCALS =========================================================
local Players         = game:GetService("Players")
local HttpService     = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local CoreGui         = game:GetService("CoreGui")

-- Wait for LocalPlayer
repeat task.wait() until Players.LocalPlayer
local LocalPlayer = Players.LocalPlayer

-- Coerce numeric config & guard
local minPlayers = tonumber(getgenv().MinPlayers) or 1
local maxPlayers = tonumber(getgenv().MaxPlayers) or 100
if minPlayers > maxPlayers then minPlayers, maxPlayers = maxPlayers, minPlayers end

local personalWebhook  = getgenv().PersonalWebhook
local sharedWebhook    = getgenv().SharedWebhook
local yourName         = getgenv().YourName or LocalPlayer.Name
local targetPets       = getgenv().TargetPetNames
local shareDiscoveries = getgenv().ShareDiscoveries

-- Stats persisted across hops
getgenv().TotalScans   = getgenv().TotalScans   or 0
getgenv().TotalFinds   = getgenv().TotalFinds   or 0
getgenv().GroupFinds   = getgenv().GroupFinds   or 0
getgenv().StartTime    = getgenv().StartTime    or os.time()

-- Hop & error control
local visitedJobIds = {[game.JobId] = true}
local hops               = 0
local maxHopsBeforeReset = 50
local teleportFails      = 0
local maxTeleportRetries = 3

local detectedPets = {}
local webhookSent  = false
local stopHopping  = false

local MAX_FETCH_FAILS = 4
local MAX_PAGE_TRIES  = 3

-- Forward declarations so we can reference before definitions
local serverHop
local sendWebhook

--== UTIL: Re-execute script after teleport ===================================
local function queueScriptSelf()
    local code = [[repeat task.wait() until game:IsLoaded(); task.wait(2);
        pcall(function()
            loadstring(game:HttpGet("]] .. tostring(getgenv().ScriptURL or "") .. [[", true))()
        end)]]
    if queue_on_teleport then queue_on_teleport(code) end
    if syn and syn.queue_on_teleport then syn.queue_on_teleport(code) end
    if fluxus and fluxus.queue_on_teleport then fluxus.queue_on_teleport(code) end
end

--== TELEPORT FAIL HANDLER =====================================================
TeleportService.TeleportInitFailed:Connect(function(_, result)
    teleportFails += 1
    warn("Teleport failed:", result)
    if teleportFails >= maxTeleportRetries then
        teleportFails = 0
        queueScriptSelf()
        TeleportService:Teleport(game.PlaceId)
        return
    end
    task.wait(1)
    if serverHop then serverHop() end
end)

--== ESP =======================================================================
local function addESP(model)
    if not model or not model:IsA("Model") then return end
    if model:FindFirstChild("PetESP", true) or model:FindFirstChild("PetHighlight", true) then return end

    local part = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart", true)
    if not part then return end

    local bb = Instance.new("BillboardGui")
    bb.Name = "PetESP"
    bb.Adornee = part
    bb.AlwaysOnTop = true
    bb.Size = UDim2.new(0, 260, 0, 72)
    bb.MaxDistance = 800
    bb.StudsOffset = Vector3.new(0, 8, 0)
    bb.Parent = part

    local lbl = Instance.new("TextLabel")
    lbl.Size = UDim2.new(1, 0, 1, 0)
    lbl.BackgroundTransparency = 0.15
    lbl.BackgroundColor3 = Color3.fromRGB(25,25,25)
    lbl.Text = "üéØ TARGET: " .. model.Name
    lbl.TextColor3 = Color3.new(1,1,1)
    lbl.TextStrokeTransparency = 0.1
    lbl.TextScaled = true
    lbl.Font = Enum.Font.GothamBlack
    lbl.Parent = bb
    local stroke = Instance.new("UIStroke", lbl)
    stroke.Color = Color3.fromRGB(255,0,0)
    stroke.Thickness = 3

    local hl = Instance.new("Highlight")
    hl.Name = "PetHighlight"
    hl.Adornee = model
    hl.FillColor = Color3.fromRGB(255,60,60)
    hl.FillTransparency = 0.75
    hl.OutlineColor = Color3.fromRGB(255,0,0)
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Parent = model
end

--== HTTP WRAPPER ==============================================================
local function sendToWebhook(url, jsonData)
    local req = http_request or request or (syn and syn.request)
    if not req then return false, "Executor HTTP not available" end
    local ok, err = pcall(function()
        req({ Url = url, Method = "POST", Headers = {["Content-Type"]="application/json"}, Body = jsonData })
    end)
    return ok, err
end

--== PROMPT: Stay or Hop =======================================================
local function promptStayOrHop(timeoutSeconds)
    timeoutSeconds = timeoutSeconds or 12
    local sg = Instance.new("ScreenGui")
    sg.Name = "PetFinderPrompt"
    sg.ResetOnSpawn = false
    sg.IgnoreGuiInset = true
    sg.ZIndexBehavior = Enum.ZIndexBehavior.Global
    sg.Parent = CoreGui

    local frame = Instance.new("Frame", sg)
    frame.Size = UDim2.new(0, 420, 0, 180)
    frame.Position = UDim2.new(0.5, -210, 0.5, -90)
    frame.BackgroundColor3 = Color3.fromRGB(22,22,22)
    frame.BorderSizePixel = 0
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

    local title = Instance.new("TextLabel", frame)
    title.BackgroundTransparency = 1
    title.Size = UDim2.new(1, -20, 0, 40)
    title.Position = UDim2.new(0,10,0,10)
    title.Text = "Secret found ‚Äî what next?"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 20
    title.TextColor3 = Color3.new(1,1,1)

    local info = Instance.new("TextLabel", frame)
    info.BackgroundTransparency = 1
    info.Size = UDim2.new(1, -20, 0, 40)
    info.Position = UDim2.new(0,10,0,50)
    info.Text = "Stay to grab it, or hop to keep scanning other servers."
    info.Font = Enum.Font.Gotham
    info.TextSize = 16
    info.TextColor3 = Color3.fromRGB(200,200,200)

    local stay = Instance.new("TextButton", frame)
    stay.Size = UDim2.new(0.5, -15, 0, 44)
    stay.Position = UDim2.new(0,10,1,-54)
    stay.Text = "Stay in this server"
    stay.Font = Enum.Font.GothamBold
    stay.TextSize = 16
    stay.TextColor3 = Color3.new(1,1,1)
    stay.BackgroundColor3 = Color3.fromRGB(31,140,76)
    Instance.new("UICorner", stay).CornerRadius = UDim.new(0,8)

    local hop = Instance.new("TextButton", frame)
    hop.Size = UDim2.new(0.5, -15, 0, 44)
    hop.Position = UDim2.new(0.5,5,1,-54)
    hop.Text = "Hop to next server"
    hop.Font = Enum.Font.GothamBold
    hop.TextSize = 16
    hop.TextColor3 = Color3.new(1,1,1)
    hop.BackgroundColor3 = Color3.fromRGB(50,90,200)
    Instance.new("UICorner", hop).CornerRadius = UDim.new(0,8)

    local choice
    stay.MouseButton1Click:Connect(function() choice = "stay"; sg:Destroy() end)
    hop.MouseButton1Click:Connect(function() choice = "hop";  sg:Destroy() end)

    task.delay(timeoutSeconds, function()
        if sg.Parent and not choice then choice = "stay"; sg:Destroy() end
    end)

    repeat task.wait() until choice ~= nil
    return choice
end

--== WEBHOOK SENDER ============================================================
function sendWebhook(foundPets)
    getgenv().TotalFinds += 1

    -- counts to "Name xN"
    local counts, lines = {}, {}
    for _, n in ipairs(foundPets) do counts[n] = (counts[n] or 0) + 1 end
    for n,c in pairs(counts) do table.insert(lines, c>1 and (n .. " x" .. c) or n) end

    local serverLink = string.format("[Join Server](https://fern.wtf/joiner?placeId=%d&gameInstanceId=%s)", game.PlaceId, game.JobId)
    local rt   = os.time() - getgenv().StartTime
    local hrs  = math.floor(rt/3600)
    local mins = math.floor((rt%3600)/60)
    local runtime = (hrs>0 and (hrs.."h ") or "") .. mins .. "m"

    -- personal
    if type(personalWebhook)=="string" and #personalWebhook>0 then
        local payload = HttpService:JSONEncode({
            content = "@everyone üö® SECRET PET DETECTED!",
            embeds = {{
                title = ("üéØ %d Secret Pet(s) Found!"):format(#foundPets),
                description = "**YOU found secret pets in this server!**",
                fields = {
                    {name="üìç Location Info", value=string.format("`TeleportToPlaceInstance(%d, \"%s\")`", game.PlaceId, game.JobId)},
                    {name="üë• Players", value=tostring(#Players:GetPlayers())},
                    {name="üêæ Pets Found", value=table.concat(lines, "\n")},
                    {name="üîó Quick Join", value=serverLink},
                    {name="üìä Your Stats", value=("Scans: %d | Finds: %d | Runtime: %s"):format(getgenv().TotalScans, getgenv().TotalFinds, runtime)},
                    {name="‚è∞ Time", value=os.date("%m/%d/%y, %I:%M %p")}
                },
                color = 0x00FF00,
                footer = {text = "Place ID: " .. game.PlaceId .. " ‚Ä¢ Found by YOU"}
            }}
        })
        sendToWebhook(personalWebhook, payload)
    end

    -- shared
    if shareDiscoveries and type(sharedWebhook)=="string" and #sharedWebhook>0 then
        local payload = HttpService:JSONEncode({
            content = "üîî Group Discovery Alert!",
            embeds = {{
                title = ("üß† %d Secret Pet(s) Found!"):format(#foundPets),
                description = "**" .. yourName .. "** discovered secret pets!",
                fields = {
                    {name="üìç Location Info", value=string.format("`TeleportToPlaceInstance(%d, \"%s\")`", game.PlaceId, game.JobId)},
                    {name="üë• Players in Server", value=tostring(#Players:GetPlayers()), inline=true},
                    {name="üîç Found By", value=yourName, inline=true},
                    {name="üêæ Pets Found", value=table.concat(lines, "\n")},
                    {name="üîó Quick Join", value=serverLink},
                    {name="‚è∞ Time", value=os.date("%m/%d/%y, %I:%M %p")}
                },
                color = 0xFF00FF,
                footer = {text = "Shared Discovery ‚Ä¢ Place ID: " .. game.PlaceId}
            }}
        })
        sendToWebhook(sharedWebhook, payload)
    end

    -- ask user what to do
    local decision = promptStayOrHop(12)
    if decision == "stay" then
        stopHopping = true
        webhookSent = false
        return
    else
        stopHopping = false
        webhookSent = false
        task.wait(0.5)
        serverHop()
    end
end

--== MATCH & SCAN ==============================================================
local function matchesTarget(name)
    if not name then return false end
    local ln = string.lower(name)
    for _, t in ipairs(targetPets) do
        if ln == string.lower(t) then return true end
    end
    return false
end

local function checkForPets()
    local found = {}
    local plots = workspace:FindFirstChild("Plots")
    if plots then
        for _, plot in ipairs(plots:GetChildren()) do
            if plot:IsA("Model") then
                for _, m in ipairs(plot:GetChildren()) do
                    if m:IsA("Model") and matchesTarget(m.Name) and not m:FindFirstChild("PetESP") then
                        addESP(m)
                        table.insert(found, m.Name)
                        stopHopping = true
                    end
                end
            end
        end
    end
    return found
end

--== SERVER HOP (DROP-IN REPLACEMENT) =========================================
function serverHop()
    if stopHopping then return end

    local PlaceId, JobId = game.PlaceId, game.JobId
    local cursor, pageTries, fetchFails = nil, 0, 0
    local backoff = 2.0  -- grows on API errors

    -- reset visited list periodically so we don't soft-lock
    hops += 1
    if hops >= maxHopsBeforeReset then
        visitedJobIds = {[JobId] = true}
        hops = 0
        print("‚ôªÔ∏è Resetting visited JobIds.")
    end

    local function forceRandomHop()
        warn("‚ö†Ô∏è Forcing random hop (fallback)‚Ä¶")
        queueScriptSelf()                 -- requeue this script after teleport
        TeleportService:Teleport(PlaceId) -- matchmaking to any public server
    end

    while pageTries < MAX_PAGE_TRIES do
        local url = ("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100"):format(PlaceId)
        if cursor then url ..= "&cursor=" .. HttpService:UrlEncode(cursor) end

        -- fetch a page safely (avoid nils / decode failures)
        local okGet, body = pcall(HttpService.GetAsync, HttpService, url, true)
        if not okGet or type(body) ~= "string" or #body == 0 then
            fetchFails += 1
            warn(("‚ö†Ô∏è Failed to fetch server list. Retrying in %.0f seconds..."):format(backoff))
            task.wait(backoff)
            backoff = math.min(backoff * 1.5, 15)
            if fetchFails >= MAX_FETCH_FAILS then return forceRandomHop() end
        else
            local okDecode, decoded = pcall(HttpService.JSONDecode, HttpService, body)
            if not okDecode or not decoded or not decoded.data then
                fetchFails += 1
                warn(("‚ö†Ô∏è Decode failed. Retrying in %.0f seconds..."):format(backoff))
                task.wait(backoff)
                backoff = math.min(backoff * 1.5, 15)
                if fetchFails >= MAX_FETCH_FAILS then return forceRandomHop() end
            else
                -- build candidate list with hard numeric guards
                local candidates = {}
                for _, s in ipairs(decoded.data) do
                    local playing = tonumber(s.playing)   or 0
                    local maxp    = tonumber(s.maxPlayers) or 1
                    if playing >= minPlayers
                       and playing <= maxPlayers
                       and playing < maxp
                       and s.id ~= JobId
                       and not visitedJobIds[s.id] then
                        table.insert(candidates, { id = s.id, players = playing })
                    end
                end

                -- hop if we found any viable server
                if #candidates > 0 then
                    table.sort(candidates, function(a,b) return a.players > b.players end)
                    local pick = candidates[1].id
                    visitedJobIds[pick] = true
                    teleportFails = 0
                    print(("‚úÖ Hopping to server with %d players: %s"):format(candidates[1].players, pick))
                    queueScriptSelf()
                    TeleportService:TeleportToPlaceInstance(PlaceId, pick)
                    return
                end

                -- advance pagination or count a page try
                cursor = decoded.nextPageCursor
                if not cursor then
                    pageTries += 1
                    task.wait(1.2)
                else
                    task.wait(0.35)
                end
            end
        end
    end

    -- scanned several pages with no candidate ‚Üí random hop
    forceRandomHop()
end


--== LIVE DETECTION ============================================================
workspace.DescendantAdded:Connect(function(obj)
    task.wait(0.25)
    local plots = workspace:FindFirstChild("Plots")
    if plots and obj:IsA("Model") and obj.Parent and obj.Parent:IsDescendantOf(plots) then
        if matchesTarget(obj.Name) and not obj:FindFirstChild("PetESP") then
            if not detectedPets[obj] then
                detectedPets[obj] = true
                addESP(obj)
                print("üéØ New pet appeared:", obj.Name)
                stopHopping = true
                if not webhookSent then
                    webhookSent = true
                    sendWebhook({obj.Name})
                end
            end
        end
    end
end)

--== BOOT ======================================================================
print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
print("üîç Pet Finder - Shared Discovery Edition")
print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
print("üë§ Username:", yourName)
print("üìä Total scans:", getgenv().TotalScans)
print("üéØ Your finds:", getgenv().TotalFinds)
print("ü§ù Group sharing:", shareDiscoveries and "ENABLED" or "DISABLED")
print("‚è±Ô∏è Session runtime:", math.floor((os.time() - getgenv().StartTime)/60) .. " minutes")
print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")

task.wait(6)
getgenv().TotalScans += 1

local first = checkForPets()
if #first > 0 then
    for _, n in ipairs(first) do detectedPets[n] = true end
    if not webhookSent then
        webhookSent = true
        print("üéØ Found pet(s):", table.concat(first, ", "))
        sendWebhook(first)
    end
else
    print("üîç No target pets found. Hopping to next server...")
    task.delay(1.5, serverHop)
end
