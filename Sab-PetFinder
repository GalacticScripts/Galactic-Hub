--// Configuration - CHANGE THESE VALUES
--// Personal Webhook (only YOU get notified)
getgenv().PersonalWebhook = "https://discord.com/api/webhooks/1436947291196882944/fHYylID8lkYCQ7A8106dRWj4clAwvei-aLIQsveHMxznrWA2gVsYkb7tzY_dpZW8fwVE"

--// Shared Webhook (ALL USERS get notified - share this with your group!)
getgenv().SharedWebhook = "https://discord.com/api/webhooks/1436947384092590116/0fWmzPrp-eHqjgfjQj5-gnsXuzv5kC00hv5gGb8uDTydbCvvuWWfE7NJl43xBl-fjITG"

--// Your Display Name (will show who found the pet)
getgenv().YourName = "YourNameHere"

getgenv().TargetPetNames = {
    "Chillin Chili", 
    "Strawberry Elephant", 
    "Los Tacoritas", 
    "La Extinct Grande", 
    "Los 67",
    "Money Money Puggy", 
    "Garama and Madundung", 
    "La Grande Combinasion", 
    "Nuclearo Dinossauro", 
    "Spaghetti Tualetti", 
    "Dragon Cannelloni", 
    "Tralaledon",
    "Ketupat Kepat", 
    "La Supreme Combinasion", 
    "Ketchuru and Musturu", 
    "Los Bros", 
    "67",
    "Los Noo My Hotspotsitos", 
    "Celularcini Viciosini", 
    "Los Combinasionas",
    "Burguro And Fryuro", 
    "Chicleteira Bicicleteira", 
    "Chicleteirina Bicicleteirina",
    "Eviledon", 
    "La Spooky Grande", 
    "Las Sis", 
    "Los Chicleteiras", 
    "Los Hotspotsitos", 
    "Los Mobilis", 
    "Mariachi Corazoni", 
    "Secret Lucky Block", 
    "Tacorita Bicicleta", 
    "Tang Tang Keletang", 
    "Tictac Sahur", 
    "To to to Sahur", 
    "Esok Sekolah", 
    "Spooky and Pumpy", 
    "Noo My Hotspot", 
    "Chipso and Queso", 
    "Mieteteira Bicicleteira", 
    "Headless Horseman",
    "La Taco Combinasion", 
    "La Casa Boo", 
    "Meowl", 
    "Los Primos", 
    "Los Spooky Combanasionias",
    "Noo my examine", 
    "Quesadilla Vampiro", 
    "Burrito Bandito", 
    "La Secret Combinasion", 
    "Horegini Boom", 
    "La Sahur Combinasion", 
    "Pot Pumpkin", 
    "Quesadilla Crocodila",
    "Rang Ring Bus",
    "Noo my Candy",
    "Vulturino Skeletono",
    "Los Tortus",
    "Blackhole Goat",
    "Los Tralaleritos",
    "Guerriro Digitale",
    "La Cucaracha",
    "Las Tralaleritas",
    "Zombie Tralala"
}

--// AUTO-EXECUTION SCRIPT URL
getgenv().ScriptURL = "https://raw.githubusercontent.com/GalacticScripts/Galactic-Hub/refs/heads/main/Sab-PetFinder"

--// SERVER FILTER SETTINGS
getgenv().MinPlayers = 5 -- Only join servers with at least this many players
getgenv().MaxPlayers = 40 -- Maximum players in server (very relaxed for more options)

--// SHARED DISCOVERY SETTINGS
getgenv().ShareDiscoveries = true -- Set to false if you don't want to share with the group
getgenv().NotifyOnGroupFinds = true -- Get notified when others in your group find pets

--// Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Wait for LocalPlayer
local LocalPlayer
repeat
    LocalPlayer = Players.LocalPlayer
    task.wait()
until LocalPlayer


--// User Configuration
local personalWebhook = getgenv().PersonalWebhook
local sharedWebhook = getgenv().SharedWebhook
local yourName = getgenv().YourName or LocalPlayer.Name
local targetPets = getgenv().TargetPetNames
local scriptURL = getgenv().ScriptURL
local minPlayers = getgenv().MinPlayers or 10
local maxPlayers = getgenv().MaxPlayers or 25
local shareDiscoveries = getgenv().ShareDiscoveries
local notifyOnGroupFinds = getgenv().NotifyOnGroupFinds

--// Global Scan Counter (persists across server hops)
if not getgenv().TotalScans then
    getgenv().TotalScans = 0
    getgenv().TotalFinds = 0
    getgenv().GroupFinds = 0 -- Tracks finds from other group members
    getgenv().StartTime = os.time()
end


--// Visited Job Tracking
local visitedJobIds = {[game.JobId] = true}
local hops = 0
local maxHopsBeforeReset = 50

--// Teleport Fail Handling
local teleportFails = 0
local maxTeleportRetries = 3

--// Found Pet Cache
local detectedPets = {}
local webhookSent = false
local stopHopping = false

--// Multiple Queue Methods for Better Compatibility
local function queueScript()
    local queueCode = [[
        repeat task.wait() until game:IsLoaded()
        task.wait(3)
        local success, err = pcall(function()
            loadstring(game:HttpGet("]] .. scriptURL .. [["))()
        end)
        if not success then
            warn("Failed to load script:", err)
        end
    ]]
    
    -- Try multiple queue methods
    if queue_on_teleport then
        queue_on_teleport(queueCode)
    end
    if syn and syn.queue_on_teleport then
        syn.queue_on_teleport(queueCode)
    end
    if fluxus and fluxus.queue_on_teleport then
        fluxus.queue_on_teleport(queueCode)
    end
end

local MAX_FETCH_FAILS = 4       -- how many fetch errors before forcing a random hop
local MAX_PAGE_TRIES  = 3       -- how many API pages to scan per hop attempt

--// Teleport Fail Handling
TeleportService.TeleportInitFailed:Connect(function(_, result)
    teleportFails += 1
    if result == Enum.TeleportResult.GameFull then
        warn("‚ö†Ô∏è Game full. Retrying teleport...")
    elseif result == Enum.TeleportResult.Unauthorized then
        warn("‚ùå Unauthorized/private server. Blacklisting and retrying...")
        visitedJobIds[game.JobId] = true
    else
        warn("‚ùå Other teleport error:", result)
    end

    if teleportFails >= maxTeleportRetries then
        warn("‚ö†Ô∏è Too many teleport fails. Forcing fresh server...")
        teleportFails = 0
        task.wait(1)
        queueScript()
        TeleportService:Teleport(game.PlaceId)
    else
        task.wait(1)
        serverHop()
    end
end)

--// ESP Function
local function addESP(targetModel)
    -- prevent duplicates
    if targetModel:FindFirstChild("PetESP", true) or targetModel:FindFirstChild("PetHighlight", true) then
        return
    end

    -- pick a BasePart to adorn
    local part = targetModel.PrimaryPart or targetModel:FindFirstChildWhichIsA("BasePart", true)
    if not part then
        warn("ESP: no BasePart for", targetModel:GetFullName())
        return
    end

    -- big on-screen label
    local bb = Instance.new("BillboardGui")
    bb.Name = "PetESP"
    bb.Adornee = part
    bb.AlwaysOnTop = true
    bb.Size = UDim2.new(0, 220, 0, 60)      -- ‚¨Ö bigger
    bb.StudsOffset = Vector3.new(0, 6, 0)   -- ‚¨Ö float higher
    bb.MaxDistance = 500                    -- ‚¨Ö visible from far away
    bb.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    bb.Parent = part

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 0.2
    label.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    label.Text = "üéØ TARGET: " .. targetModel.Name
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextStrokeTransparency = 0.15
    label.TextScaled = true
    label.Font = Enum.Font.GothamBlack
    label.Parent = bb

    -- add a fat border
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 2.5
    stroke.Color = Color3.fromRGB(255, 0, 0)
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    stroke.Parent = label

    -- world-space halo on the model
    local hl = Instance.new("Highlight")
    hl.Name = "PetHighlight"
    hl.Adornee = targetModel
    hl.FillColor = Color3.fromRGB(255, 60, 60)
    hl.FillTransparency = 0.75
    hl.OutlineColor = Color3.fromRGB(255, 0, 0)
    hl.OutlineTransparency = 0
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Parent = targetModel
end


--// Send to Webhook Function
local function sendToWebhook(webhookUrl, jsonData)
    local req = http_request or request or syn and syn.request
    if req then
        local success, err = pcall(function()
            req({
                Url = webhookUrl,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = jsonData
            })
        end)
        return success, err
    end
    return false, "Executor doesn't support HTTP requests"
end

--// Webhook Function (Dual Webhook System)
local function sendWebhook(foundPets)
    getgenv().TotalFinds += 1

    local petCounts = {}
    for _, pet in ipairs(foundPets) do
        if pet then
            petCounts[pet] = (petCounts[pet] or 0) + 1
        end
    end

    local formattedPets = {}
    for petName, count in pairs(petCounts) do
        table.insert(formattedPets, count > 1 and petName .. " x" .. count or petName)
    end

    local serverLink = "[Join Server](https://fern.wtf/joiner?placeId=" .. game.PlaceId .. "&gameInstanceId=" .. game.JobId .. ")"
    
    local runTime = os.time() - getgenv().StartTime
    local hours = math.floor(runTime / 3600)
    local minutes = math.floor((runTime % 3600) / 60)
    local timeStr = hours > 0 and string.format("%dh %dm", hours, minutes) or string.format("%dm", minutes)

    -- Personal Webhook (Your Private Alerts)
    if type(personalWebhook) == "string" and #personalWebhook > 0 then
        local personalData = HttpService:JSONEncode({
            ["content"] = "@everyone üö® SECRET PET DETECTED!",
            ["embeds"] = {{
                ["title"] = "üéØ " .. #foundPets .. " Secret Pet(s) Found!",
                ["description"] = "**YOU found secret pets in this server!**",
                ["fields"] = {
                    { ["name"] = "üìç Location Info", ["value"] = "`game:GetService('TeleportService'):TeleportToPlaceInstance(" .. game.PlaceId .. ", '" .. game.JobId .. "')`" },
                    { ["name"] = "üë• Players", ["value"] = tostring(#Players:GetPlayers()) },
                    { ["name"] = "üêæ Pets Found", ["value"] = table.concat(formattedPets, "\n") },
                    { ["name"] = "üîó Quick Join", ["value"] = serverLink },
                    { ["name"] = "üìä Your Stats", ["value"] = "Scans: " .. getgenv().TotalScans .. " | Finds: " .. getgenv().TotalFinds .. " | Runtime: " .. timeStr },
                    { ["name"] = "‚è∞ Time", ["value"] = os.date("%m/%d/%y, %I:%M %p") }
                },
                ["color"] = 0x00FF00,
                ["footer"] = {
                    ["text"] = "Place ID: " .. game.PlaceId .. " ‚Ä¢ Found by YOU"
                },
                ["thumbnail"] = {
                    ["url"] = "https://cdn.discordapp.com/emojis/1234567890123456789.png"
                }
            }}
        })
        
        local success = sendToWebhook(personalWebhook, personalData)
        if success then
            print("‚úÖ Personal webhook sent!")
        end
    end

    -- Shared Webhook (Group Discovery System)
    if shareDiscoveries and type(sharedWebhook) == "string" and #sharedWebhook > 0 then
        local sharedData = HttpService:JSONEncode({
            ["content"] = "üîî Group Discovery Alert!",
            ["embeds"] = {{
                ["title"] = "üß† " .. #foundPets .. " Secret Pet(s) Found!",
                ["description"] = "**" .. yourName .. "** discovered secret pets!",
                ["fields"] = {
                    { ["name"] = "üìç Location Info", ["value"] = "`game:GetService('TeleportService'):TeleportToPlaceInstance(" .. game.PlaceId .. ", '" .. game.JobId .. "')`" },
                    { ["name"] = "üë• Players in Server", ["value"] = tostring(#Players:GetPlayers()), ["inline"] = true },
                    { ["name"] = "üîç Found By", ["value"] = yourName, ["inline"] = true },
                    { ["name"] = "üêæ Pets Found", ["value"] = table.concat(formattedPets, "\n") },
                    { ["name"] = "üîó Quick Join", ["value"] = serverLink },
                    { ["name"] = "‚è∞ Time", ["value"] = os.date("%m/%d/%y, %I:%M %p") }
                },
                ["color"] = 0xFF00FF,
                ["footer"] = {
                    ["text"] = "Shared Discovery ‚Ä¢ Place ID: " .. game.PlaceId
                }
            }}
        })
        
        local success = sendToWebhook(sharedWebhook, sharedData)
        if success then
            print("‚úÖ Shared discovery sent to group!")
        end
    end

        -- Wait 5 seconds before hopping to give time to join
    task.wait(5)
    stopHopping = false
    webhookSent = false
    serverHop()
end

--// Strict Target Matching
local function matchesTarget(petName)
    for _, target in ipairs(targetPets) do
        if string.lower(petName) == string.lower(target) then
            return true
        end
    end
    return false
end

--// Check all plots for exact pets
local function checkForPets()
    local found = {}
    if workspace:FindFirstChild("Plots") then
        for _, plot in ipairs(workspace.Plots:GetChildren()) do
            if plot:IsA("Model") then
                for _, obj in ipairs(plot:GetChildren()) do
                    if obj:IsA("Model") and matchesTarget(obj.Name) and not obj:FindFirstChild("PetESP") then
                        addESP(obj)
                        table.insert(found, obj.Name)
                        stopHopping = true
                    end
                end
            end
        end
    end
    return found
end

--// Server Hop Function
function serverHop()
    if stopHopping then return end

    local PlaceId, JobId = game.PlaceId, game.JobId
    local fetchFails = 0
    local backoff = 3.0    -- seconds, increases each fetch fail
    local tries = 0
    local cursor = nil

    hops += 1
    if hops >= maxHopsBeforeReset then
        visitedJobIds = {[JobId] = true}
        hops = 0
        print("‚ôªÔ∏è Resetting visited JobIds.")
    end

    local function forceRandomHop()
        warn("‚ö†Ô∏è Forcing random hop (fallback)‚Ä¶")
        queueScript()
        TeleportService:Teleport(PlaceId) -- matchmaking to any public server
    end

    while tries < MAX_PAGE_TRIES do
        local url = ("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100"):format(PlaceId)
        if cursor then url ..= "&cursor=" .. cursor end

        local ok, decoded = pcall(function()
            -- using HttpService:GetAsync avoids some caching quirks; decode after
            local raw = HttpService:GetAsync(url, true)
            return HttpService:JSONDecode(raw)
        end)

        if not ok or not decoded or not decoded.data then
            fetchFails += 1
            warn(("‚ö†Ô∏è Failed to fetch server list. Retrying in %.0f seconds..."):format(backoff))
            task.wait(backoff)
            backoff = math.min(backoff + 3, 15) -- gentle linear backoff, capped
            if fetchFails >= MAX_FETCH_FAILS then
                return forceRandomHop()
            end
            -- try again without advancing page counter
        else
            -- build candidate list
            local servers = {}
            for _, s in ipairs(decoded.data) do
                local playing = tonumber(s.playing or 0) or 0
                local maxp    = tonumber(s.maxPlayers or 1) or 1
                if playing >= minPlayers
                   and playing <= maxPlayers
                   and playing < maxp
                   and s.id ~= JobId
                   and not visitedJobIds[s.id] then
                    table.insert(servers, { id = s.id, players = playing })
                end
            end

            if #servers > 0 then
                table.sort(servers, function(a,b) return a.players > b.players end)
                local pick = servers[1].id
                visitedJobIds[pick] = true
                print(("‚úÖ Hopping to server with %d players: %s"):format(servers[1].players, pick))
                teleportFails = 0
                queueScript()
                TeleportService:TeleportToPlaceInstance(PlaceId, pick)
                return
            end

            cursor = decoded.nextPageCursor
            if not cursor then
                tries += 1
                task.wait(1.5)
            else
                task.wait(0.4)
            end
        end
    end

    -- scanned a few pages and/or couldn‚Äôt find a candidate ‚Äî force random hop
    forceRandomHop()
end



--// Live Detection
workspace.DescendantAdded:Connect(function(obj)
    task.wait(0.25)
    if obj:IsA("Model") and obj.Parent and obj.Parent:IsDescendantOf(workspace.Plots) then
        if matchesTarget(obj.Name) and not obj:FindFirstChild("PetESP") then
            if not detectedPets[obj] then
                detectedPets[obj] = true
                addESP(obj)
                print("üéØ New pet appeared:", obj.Name)
                stopHopping = true
                if not webhookSent then
                    sendWebhook({obj.Name})
                    webhookSent = true
                end
            end
        end
    end
end)

--// Start
print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
print("üîç Pet Finder - Shared Discovery Edition")
print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
print("üë§ Username:", yourName)
print("üìä Total scans:", getgenv().TotalScans)
print("üéØ Your finds:", getgenv().TotalFinds)
print("ü§ù Group sharing:", shareDiscoveries and "ENABLED" or "DISABLED")
print("‚è±Ô∏è Session runtime:", math.floor((os.time() - getgenv().StartTime) / 60) .. " minutes")
print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")

task.wait(6)
getgenv().TotalScans += 1

local petsFound = checkForPets()
if #petsFound > 0 then
    for _, name in ipairs(petsFound) do
        detectedPets[name] = true
    end
    if not webhookSent then
        print("üéØ Found pet(s):", table.concat(petsFound, ", "))
        sendWebhook(petsFound)
        webhookSent = true
    end
else
    print("üîç No target pets found. Hopping to next server...")
    task.delay(1.5, serverHop)
end

